library(limma)
library(tidyr)
library(ggplot2)
library(ggpubr)

#---Analysis of long COVID

#---Read in the OLINK NPX file
olinkdata_og <- read.csv("IRIS_LongCOVID_olink_data.csv",
                      h = TRUE)

#---Subset to retain samples collected at the 3-month timepoint
olinkdata <- subset(olinkdata_og, olinkdata_og$timing_month=="3 months")
olinkdata <- subset(olinkdata, olinkdata$Sex=="Male")

#---Create a sample table
olinkdata$timing_month <- gsub(" months", "_months", olinkdata$timing_month)
olinkdata$sampleID <- paste0(olinkdata$IRIS_number, "-", olinkdata$timing_month)
sampleTable <- subset(olinkdata, select=c("Sex", "IRIS_number", "long_covid"))
sampleTable <- sampleTable[!duplicated(sampleTable), ]
sampleTable$long_covid <- as.factor(sampleTable$long_covid)

#--Create a table with protein expression data
npx_data <- subset(olinkdata, select=c("Assay", "NPX", "IRIS_number"))
npx_data <- pivot_wider(npx_data, names_from=IRIS_number, values_from=NPX)
npx_data <- as.data.frame(npx_data)
rownames(npx_data) <- npx_data$Assay
npx_data$Assay <- NULL
npx_data <- as.matrix(npx_data)

#---Limma model to assess differential abundance
design <- model.matrix(~ long_covid, sampleTable)
fit <- lmFit(npx_data, design)
fit <- eBayes(fit, trend=TRUE)
res_top <- topTable(fit, coef=ncol(design), genelist=fit$genes,number=Inf,adjust="BH")
print(subset(res_top, res_top$P.Value < 0.05, (select=c("logFC", "P.Value", "adj.P.Val"))))

#---T-test to compare LAP TGF-beta expression in recovered vs long COVID during Acute Infection
olinkdata_acute <- subset(olinkdata_og, olinkdata_og$timing_month=="Acute")
olinkdata_acute <- subset(olinkdata, olinkdata$Sex=="Male")

tgfbeta <- subset(olinkdata_acute, olinkdata$Assay=="LAP TGF-beta-1")
tgfbeta$long_covid <- gsub("1", "Long COVID", tgfbeta$long_covid)
tgfbeta$long_covid <- gsub("0", "Recovered", tgfbeta$long_covid)
tgfbeta$long_covid <- as.factor(tgfbeta$long_covid)
ggplot(tgfbeta, aes(x = long_covid, y = NPX, fill = long_covid))  +
  geom_boxplot(outlier.shape = NA) + ggtitle("LAP TGF-beta-1 levels during Acute infection: Long COVID vs Recovered") + geom_jitter(width=0.2)  +
  theme_classic() + scale_fill_manual(values = c("#F69C9E", "lightblue")) +
  ylab("NPX") + stat_compare_means(aes(label = paste0(after_stat(method), " p = ", after_stat(p.format))))

